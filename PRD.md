# 产品需求文档

为了帮助不擅长/不愿意整理电脑文件的人，设计一个产品帮助用户发现和利用电脑中保存在各类文档中的知识。

在用户的授权下读取保存有用户有感知的文件，所谓有感知的文件是指用户知道这些文件的存在，并且是在各类软件的要求下明确保存下来的文件。对此我们要求用户在macOS和Windows上给读取文件夹的授权，初始扫描加后续监控文件变化，迅速生成对用户有意义的标签，也方便用户利用其中的知识跟LLM做有价值的对话，积累用户的知识库。

## 动态标签系统

本App会根据文件名、文件所在路径中的信息、文件内容、元数据中时间类信息等为文件打上多个标签，以便用户更方便地进行搜索和后续的知识抽取和利用。

标签都是有语义的，语义范围也体现了对文件价值描述的不同颗粒度。

标签用法：

- 单个标签当作文件夹用
- 可以通过标签搜索文件，即多标签聚合。具体为：在聊天框即时从用户的输入中提取多标签后聚合以动态生成文件列表。

标签由几种来源：

- 本App预设标签：项目、重要、旅行、汇报、论文等，作为LLM给文件打标签的参考。
- 用户自定义标签：用户可以在App中添加、修改、删除标签，标签的语义范围由用户决定。
- LLM生成的标签：体现LLM智能的一点就是不断在跟用户的对话中发现、积累、评估后使用已有标签或新创标签，体现了人工智能时代的产品特性。

## 技术流程设计

在这个Tauri App中，是三种语言混合使用：

- TypeScript负责前端界面呈现和交互逻辑
- Rust直接跟操作系统打交道，做文件查找和扫描等
- Python负责处理数据和跟数据库打交道，也负责调用LLM

技术流程概述：

1. 前端TypeScript跟Python API配合，按照Windows和macOS不同常用文件夹列表，通过“完全磁盘访问权限”请求用户授权。
2. Rust的“粗筛(screening)”工作
   1. 读取文件元数据(路径、大小、时间戳、计算基本哈希，注意这阶段并不读取文件内容)，进行初步规则匹配(如扩展名分类、简单文件名模式等等)
   2. 将更结构化的任务信息(包含元数据和初步分类结果)通过Python API入库到粗筛结果表
3. Python的“打标签(tagging)”工作，此过程可认为是粗放的解析(Parsing)
   1. Rust向任务表插入记录，Python的worker从粗筛结果表拿到相关数据
   2. 使用markitdown对其支持的文件格式进行解析，虽然它会丢失图片信息，但单纯文本内容的解析和标签生成是可行的
   3. 使用LLM利用粗筛数据和解析后的内容进行标签的生成，保存到标签库。考虑到执行效率和LLM上下文窗口限制，不用将完整内容给到LLM
4. “精炼(refine)”工作是复杂的人机交互过程，包括更精细的解析(Parsing)、提取(Extraction)、分块(Chunking)、向量化(Embedding)等步骤形成可被RAG的知识片段
   1. 用户在前端界面上尝试不同工具直观的进行文件内容的解析，Python后端功能库进行配合
   2. 用户可以选择将文件内容的某些片段经LLM简单处理后作为知识片段保存到知识库中

这个设计兼顾了性能和质量：

- Rust运用高性能的I/O能力将频繁变更的文件元数据进行规则处理筛选后，传递给Python的任务量大大减少，减少了后续计算压力
- Python对文件内容做粗放的解析(仅用markitdown快速处理，遗失一些信息也无妨)，生成标签，以便在精炼过程前筛选并缩小文件范围
- Python在同用户的交互过程中对文件进行详细的解析和提取，形成高质量的知识片段。

## 总结

这是一个从粗筛到精炼的三级质量体系。

1. 最初通过文件全路径(主文件名，扩展名，路径内的语义信息)快速进行粗筛，圈定用户有明确感知的携带了知识的文件。
2. 接着通过对文件内容的粗放解析，生成初步的标签，帮助用户快速定位和筛选文件。
3. 最后，通过用户交互和LLM的智能处理，对文件内容进行深入解析和知识片段的提取。

用户通过选择不同的工具对比解析效果，并通过对话的方式将自身认知、LLM模型内知识、文件内知识和外部世界知识(调用搜索工具等)进行整合和“精炼”，形成了用户有感知、有印象的知识库的积累。
