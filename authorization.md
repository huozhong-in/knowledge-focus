# 监控文件夹管理

## 功能概述

本App启动时通过介绍页(IntroDialog)检查和强制获取“完全磁盘访问权限/管理员权限”，没有权限则不允许进入主界面。

- macOS的"完全磁盘访问权限"

  - 使用[tauri-plugin-macos-permissions](https://crates.io/crates/tauri-plugin-macos-permissions) 能检测及获取权限。获取权限自动打开macOS系统设置窗，设置完毕后提示重启App生效。

- Windows的安全机制比较粗放，只要App拥有管理员权限，或"使用管理员权限打开"，整个磁盘都能读取。

  -鉴于本次重构只在macOS进行，Windows的权限获取不在本次重构范围内。

本App启动后检查上述授权情况和Python API的可用性，成功后从Python API `/config/all` endpoint拿到黑白名单及各种粗筛条件，开启对多个文件夹的监控，同时开始首次的全面粗筛。

白名单默认包含当前操作系统的常见文件夹(如桌面、下载、文档等)，黑名单默认为空。本App通过一个管理界面，让用户管理黑白名单，在首次粗筛期间的用户操作将会进入一个操作队列，待首次粗筛完成后再执行，队列处理器只需处理以下6种情况：

- 用户将某常见文件夹改为黑名单item：
  1. 前端调用Python API更新相关配置表
  2. 前端通知Rust使用新的监控列表重启防抖监控器，并添加“清理单文件夹对应粗筛记录”任务到队列（而不是直接调用Python API，防止出现脏数据）
- 用户将某常见文件夹改回白名单item：
  1. 前端调用Python API更新相关配置表
  2. 前端通知Rust使用新的监控列表重启防抖监控器，并添加“单文件夹”粗筛任务到队列
- 用户新增白名单item：
  1. 前端调用Python API新增相关配置表
  2. 前端通知Rust使用新的监控列表重启防抖监控器，并添加“单文件夹”粗筛任务到队列
- 用户删除白名单item：
  1. 前端调用Python API删除相关配置表
  2. 前端通知Rust使用新的监控列表重启防抖监控器，并添加“清理单文件夹对应粗筛记录”任务到队列
- 用户新增黑名单item：
  1. 前端调用Python API新增相关配置表
  2. 前端通知Rust使用新的监控列表重启防抖监控器，并添加“清理单文件夹对应粗筛记录”任务到队列
- 用户删除黑名单item：
  1. 前端调用Python API删除相关配置表
  2. 前端通知Rust使用新的监控列表重启防抖监控器，并添加“单文件夹”粗筛任务到队列

另外，本界面上的“新增/删除bundle扩展名”的配置操作，通过Python API写库，并提示用户重启App生效。macOS的bundle性质文件其实是文件夹，里面的文件均没必要扫描，在递归扫描时检测是bundle就不必深入。

## 界面和交互

- 界面预置当前OS常见文件夹列表，也可自助添加其他文件夹(检查是否已添加)。
  - 界面右上角“添加文件夹”按钮只能添加白名单item。
  - 常见文件夹不可删除，但可以变为黑名单item(其下原有黑名单item会被“合并”，从数据表删除)，和转回白名单item。
  - 后来自助添加的文件夹可以删除。

- 相同权限向子文件夹递归，没必要重复授权
  - 黑名单item只能添加在白名单item下，并明确显示其上下级关系(不论中间存在几层parent)。所以“添加黑名单文件夹”按钮放在每个白名单item附近。
  - 黑名单item下不能再添加白名单item。
  - 这样的设计，界面上的呈现就是两层：一级黑名单item(属于OS常见文件夹，无法删除但可转白)，或一级白名单item下可能带一个或多个二级黑名单item。
