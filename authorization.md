# 授权和文件夹管理

## 功能概述

通过一个管理界面，让用户确定本App读取哪些文件夹(白名单)，不要读取哪些文件夹(黑名单)。
其技术前提是：本App必须获得读取权限，为了降低复杂度，尽量获得最大权限。在不同操作系统上情况不同：

- macOS的“完全磁盘访问权限”

使用[tauri-plugin-macos-permissions](https://crates.io/crates/tauri-plugin-macos-permissions) 能检测及获取权限。获取权限自动打开macOS系统设置窗，设置完毕后提示重启App生效。
注意在开发环境下是授权给VSCode/Cursor等IDE App，编译后的独立程序才是授权给App自身。

- Windows的安全机制比较粗放，只要App拥有管理员权限，或“使用管理员权限打开”，整个磁盘都能读取。

在App启动时检查和获取权限，否则启动失败。

## 界面和交互

- 界面预置当前OS常见文件夹列表，也可自助添加其他文件夹(检查是否已添加)。
  - 界面右上角“添加文件夹”按钮只能添加白名单item。
  - 常见文件夹不可删除，但可以变为黑名单item。(其下原有黑名单item会被“合并”，从数据表删除)
  - 后来自动添加的文件夹可以删除。

- 相同权限向子文件夹递归，没必要重复授权
  - 黑名单item只能添加在白名单item下，并明确显示其上下级关系(不论中间存在几层parent)。所以“添加黑名单文件夹”按钮放在每个白名单item附近。
  - 黑名单item下不能再添加白名单item。
  - 这样的设计，界面上的呈现就是两层：黑名单item，或白名单item下会带一个或多个黑名单item。

- macOS的bundle性质文件其实是文件夹，里面的文件均没必要扫描，在递归扫描时检测是bundle就不再深入。这样的文件夹除了带有用点分隔的“扩展名”外，外部程序无从分辨，所以要收集这类扩展名，也就是要维护一个bundle“扩展名”名单。

## 相关技术流程

- 本App启动后通过Python API从数据表读取 /config/all endpoint，拿到黑白名单及各种粗筛条件，开始首次的全面粗筛。
- 将某常见文件夹改为黑名单item：前端调用Python API更新“监控文件夹表”记录、删除“粗筛结果”表相关记录，前端通知Rust变更内存中监控列表。
- 将某常见文件夹改回白名单item：前端调用Python API更新“监控文件夹表”记录，前端通知Rust变更内存中监控列表，针对此item开始增量粗筛。
- 新增白名单item：前端调用Python API新增“监控文件夹表”记录，前端通知Rust变更内存中监控列表，针对此item开始增量粗筛。
- 删除白名单item：前端调用Python API删除“监控文件夹表”记录、删除“粗筛结果”表相关记录，前端通知Rust变更内存中监控列表.
- 新增黑名单item：前端调用Python API新增“监控文件夹表”记录、删除“粗筛结果”表相关记录，前端通知Rust变更内存中监控列表。
- 新增/删除bundle扩展名，因操作不常见，为了简化处理仅变更bundle表、删除粗筛记录，配置在下次App启动时会生效。
- Rust接到文件创建、删除、修改事件，针对此文件开始增量粗筛(已实现针对短时间大量事件的防抖机制)。
